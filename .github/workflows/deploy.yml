name: ğŸš€ Build and Deploy Enhanced Book

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_formats:
        description: 'Formatos a construir (html,pdf,epub,docx)'
        required: false
        default: 'html'
        type: string
      deploy_mode:
        description: 'Modo de despliegue'
        required: false
        default: 'pages'
        type: choice
        options:
        - pages
        - full
        - test

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  QUARTO_VERSION: "1.4.550"
  NODE_VERSION: "18"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      formats-built: ${{ steps.build-summary.outputs.formats }}
      build-success: ${{ steps.build-summary.outputs.success }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para obtener toda la historia

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'api-server/package-lock.json'

      - name: ğŸ“¦ Install API dependencies
        run: |
          cd api-server
          npm ci --only=production

      - name: ğŸ¯ Install Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: ${{ env.QUARTO_VERSION }}

      - name: ğŸ Setup Python for Quarto
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“š Install additional dependencies
        run: |
          # Instalar dependencias para formatos adicionales
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-latex-recommended texlive-latex-extra
          
          # Instalar herramientas de optimizaciÃ³n
          npm install -g terser
          
          # Verificar instalaciones
          echo "âœ… Quarto version: $(quarto --version)"
          echo "âœ… Pandoc version: $(pandoc --version | head -1)"
          echo "âœ… Node.js version: $(node --version)"

      - name: ğŸ” Validate content and dependencies
        run: |
          # Verificar que todos los archivos QMD existen
          echo "ğŸ“‹ Verificando archivos de contenido..."
          
          missing_files=()
          for file in index.qmd interactive-playground.qmd navegacion.qmd archivos.qmd busqueda.qmd desarrollo.qmd multimedia.qmd red.qmd monitoreo.qmd texto.qmd utilidades.qmd combinaciones.qmd configuracion.qmd ecosystem-integration.qmd; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "âŒ Archivos faltantes: ${missing_files[*]}"
            exit 1
          fi
          
          # Verificar configuraciÃ³n de Quarto
          echo "ğŸ”§ Verificando configuraciÃ³n de Quarto..."
          quarto check
          
          echo "âœ… ValidaciÃ³n completada"

      - name: ğŸ—ï¸ Build book formats
        id: build-book
        run: |
          # Determinar quÃ© formatos construir
          FORMATS="${{ github.event.inputs.build_formats || 'html' }}"
          echo "ğŸ“š Construyendo formatos: $FORMATS"
          
          # Crear directorio de assets si no existe
          mkdir -p assets
          
          # Construir cada formato solicitado
          BUILT_FORMATS=""
          
          if [[ "$FORMATS" == *"html"* ]]; then
            echo "ğŸŒ Construyendo HTML..."
            quarto render --to html
            
            # Copiar archivos interactivos adicionales
            cp tools-explorer.html _book/ 2>/dev/null || echo "âš ï¸ tools-explorer.html no encontrado"
            cp tools-index.json _book/ 2>/dev/null || echo "âš ï¸ tools-index.json no encontrado"
            cp interactive-features.js _book/ 2>/dev/null || echo "âš ï¸ interactive-features.js no encontrado"
            cp custom-interactive.css _book/ 2>/dev/null || echo "âš ï¸ custom-interactive.css no encontrado"
            
            # Minificar JavaScript si existe
            if [ -f "_book/interactive-features.js" ] && command -v terser &> /dev/null; then
              terser _book/interactive-features.js -o _book/interactive-features.min.js
              echo "âœ… JavaScript minificado"
            fi
            
            BUILT_FORMATS="${BUILT_FORMATS},html"
            echo "âœ… HTML construido exitosamente"
          fi
          
          if [[ "$FORMATS" == *"pdf"* ]]; then
            echo "ğŸ“„ Construyendo PDF..."
            if quarto render --to pdf; then
              BUILT_FORMATS="${BUILT_FORMATS},pdf"
              echo "âœ… PDF construido exitosamente"
            else
              echo "âš ï¸ Error construyendo PDF (puede requerir configuraciÃ³n adicional de LaTeX)"
            fi
          fi
          
          if [[ "$FORMATS" == *"epub"* ]]; then
            echo "ğŸ“± Construyendo EPUB..."
            if quarto render --to epub; then
              BUILT_FORMATS="${BUILT_FORMATS},epub"
              echo "âœ… EPUB construido exitosamente"
            else
              echo "âš ï¸ Error construyendo EPUB"
            fi
          fi
          
          if [[ "$FORMATS" == *"docx"* ]]; then
            echo "ğŸ“ Construyendo DOCX..."
            if quarto render --to docx; then
              BUILT_FORMATS="${BUILT_FORMATS},docx"
              echo "âœ… DOCX construido exitosamente"
            else
              echo "âš ï¸ Error construyendo DOCX"
            fi
          fi
          
          # Guardar formatos construidos
          echo "formats=${BUILT_FORMATS#,}" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Generate build manifest
        run: |
          # Crear manifiesto del build
          cat > _book/build-manifest.json << EOF
          {
            "version": "2.0.0",
            "build_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "build_system": "GitHub Actions - ${{ runner.os }}",
            "commit_sha": "${{ github.sha }}",
            "commit_ref": "${{ github.ref }}",
            "quarto_version": "$(quarto --version)",
            "pandoc_version": "$(pandoc --version | head -1)",
            "formats_built": "${{ steps.build-book.outputs.formats }}",
            "interactive_features": {
              "code_editing": true,
              "simulated_execution": true,
              "snippet_management": true,
              "api_integration": true,
              "responsive_design": true,
              "dark_mode": true
            },
            "ecosystem_components": {
              "dashboard": $([ -f "_book/tools-explorer.html" ] && echo "true" || echo "false"),
              "api_server": true,
              "cli_tool": true,
              "vscode_extension": true,
              "docker_support": true
            }
          }
          EOF
          
          echo "âœ… Manifiesto generado"

      - name: ğŸ” Build summary
        id: build-summary
        run: |
          # Verificar quÃ© se construyÃ³ exitosamente
          formats_built="${{ steps.build-book.outputs.formats }}"
          
          echo "ğŸ“‹ Resumen del build:"
          echo "   Formatos solicitados: ${{ github.event.inputs.build_formats || 'html' }}"
          echo "   Formatos construidos: $formats_built"
          
          # Verificar archivos generados
          echo "ğŸ“ Archivos en _book/:"
          ls -la _book/ || echo "âŒ Directorio _book no encontrado"
          
          # Calcular tamaÃ±o del build
          if [ -d "_book" ]; then
            size_mb=$(du -sm _book | cut -f1)
            echo "ğŸ“ TamaÃ±o del build: ${size_mb}MB"
          fi
          
          # Guardar estado del build
          if [ -f "_book/index.html" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          
          echo "formats=$formats_built" >> $GITHUB_OUTPUT

      - name: ğŸ—œï¸ Optimize output
        if: steps.build-summary.outputs.success == 'true'
        run: |
          cd _book
          
          # Generar checksums para archivos importantes
          if command -v sha256sum &> /dev/null; then
            find . -name "*.pdf" -o -name "*.epub" -o -name "*.docx" -o -name "*.html" | \
              xargs sha256sum > checksums.sha256 2>/dev/null || echo "âš ï¸ No se pudieron generar checksums"
          fi
          
          echo "âœ… OptimizaciÃ³n completada"

      - name: ğŸ“¤ Setup GitHub Pages
        if: github.ref == 'refs/heads/main' && steps.build-summary.outputs.success == 'true'
        uses: actions/configure-pages@v4

      - name: ğŸ“¦ Upload Pages artifact
        if: github.ref == 'refs/heads/main' && steps.build-summary.outputs.success == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_book

      - name: ğŸ“Š Upload build artifacts (additional formats)
        if: steps.build-summary.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cli-tools-guide-all-formats
          path: |
            _book/*.pdf
            _book/*.epub
            _book/*.docx
            _book/build-manifest.json
            _book/checksums.sha256
          retention-days: 30

  # Deploy job
  deploy:
    if: github.ref == 'refs/heads/main' && needs.build.outputs.build-success == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ğŸ“Š Deployment summary
        run: |
          echo "âœ… Despliegue completado exitosamente"
          echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“¦ Formatos desplegados: ${{ needs.build.outputs.formats-built }}"

  # Test examples job (only on PRs and workflow_dispatch)
  test-examples:
    runs-on: macos-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸº Setup Homebrew
        run: |
          # Homebrew should already be installed on GitHub's macOS runners
          brew --version || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: ğŸ”§ Install CLI tools for testing
        run: |
          # Instalar herramientas comunes mencionadas en el libro
          brew install fd ripgrep bat eza jq fzf tree htop
          
          # Verificar instalaciones
          echo "âœ… Herramientas instaladas:"
          fd --version
          rg --version
          bat --version
          eza --version
          jq --version
          fzf --version

      - name: ğŸ§ª Test CLI examples from book
        run: |
          # Crear archivos de prueba
          mkdir -p test-workspace
          cd test-workspace
          echo "Hello World" > test.txt
          echo '{"name": "CLI Guide", "version": "2.0.0"}' > package.json
          
          # Probar comandos del libro
          echo "ğŸ” Probando bÃºsqueda con ripgrep..."
          rg "Hello" test.txt
          
          echo "ğŸ“ Probando listado con eza..."
          eza -la
          
          echo "ğŸ¯ Probando procesamiento JSON con jq..."
          jq '.name' package.json
          
          echo "ğŸŒ³ Probando visualizaciÃ³n con tree..."
          tree .
          
          echo "âœ… Todos los ejemplos funcionan correctamente"

      - name: ğŸ—ï¸ Test book build
        run: |
          # Instalar Quarto para pruebas
          cd /tmp
          wget https://github.com/quarto-dev/quarto-cli/releases/download/v1.4.550/quarto-1.4.550-linux-amd64.tar.gz
          tar -xzf quarto-1.4.550-linux-amd64.tar.gz
          sudo cp quarto-1.4.550/bin/quarto /usr/local/bin/
          
          # Volver al directorio del proyecto y probar build
          cd $GITHUB_WORKSPACE
          quarto check
          
          # Build de prueba (solo HTML para velocidad)
          quarto render --to html
          
          echo "âœ… Build de prueba exitoso"

  # Notification job
  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“± Notify build status
        uses: actions/github-script@v7
        with:
          script: |
            const buildSuccess = '${{ needs.build.outputs.build-success }}' === 'true';
            const deploySuccess = '${{ needs.deploy.result }}' === 'success';
            const formatsBuilt = '${{ needs.build.outputs.formats-built }}';
            
            const status = buildSuccess && deploySuccess ? 'âœ… Ã‰XITO' : 'âŒ FALLO';
            const emoji = buildSuccess && deploySuccess ? 'ğŸš€' : 'ğŸ’¥';
            
            const body = `
            ${emoji} **CLI Tools Guide - Build Report**
            
            **Estado:** ${status}
            **Commit:** ${context.sha.substring(0, 7)}
            **Rama:** ${context.ref.replace('refs/heads/', '')}
            **Formatos construidos:** ${formatsBuilt || 'ninguno'}
            
            **Resultados:**
            - Build: ${buildSuccess ? 'âœ…' : 'âŒ'}
            - Deploy: ${deploySuccess ? 'âœ…' : 'âŒ'}
            
            **Enlaces:**
            - [Ver sitio](https://laguileracl.github.io/homebrew-cli-guide/)
            - [Ver commit](${context.payload.repository.html_url}/commit/${context.sha})
            - [Ver workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            // Create or update issue comment for continuous deployment tracking
            const issue_number = 1; // Assuming issue #1 for deployment tracking
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: body
              });
            } catch (error) {
              console.log('No se pudo crear comentario de seguimiento:', error.message);
            }
            
            console.log('ğŸ“Š Build completado:', {
              buildSuccess,
              deploySuccess,
              formatsBuilt,
              sha: context.sha.substring(0, 7)
            });
